#!/usr/bin/env ruby

require 'simple_mmap'
require 'webink/beauty'

config = nil
model_classes = Array.new

begin
  config = Ink::Beauty.load_config "./"
rescue Exception => bang
  puts "Error while loading config: #{bang}."
end

require "#{config["db_type"]}"
require 'webink'

models = Dir.new "./models"
models.each do |model|
  load "#{models.path}/#{model}" if model =~ /\.rb$/
  model_classes.push Ink::Model.classname($1) if model =~ /^(.*)\.rb$/
end

begin
  Ink::Database.create config
  db = Ink::Database.database
  db_tables = db.tables

  if ARGV[0] == "drop"
    puts "Dropping old tables..."
    db_tables.each do |t|
      puts "...#{t}"
      db.query "DROP TABLE #{t};"
    end
  end

  puts "Creating new tables..."
  model_classes.each do |m|
    puts "...for class: #{m.name}:"
    c = m.create
    puts c
    c.each do |exec|
      begin
        db.query exec
      rescue => ex
        puts ex
      end
    end
  end
rescue Exception => bang
  puts "SQLError: #{bang}."
end
