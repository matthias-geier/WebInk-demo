#!/usr/bin/env ruby

require "fcgi"
require "simple_mmap"
require "webink/beauty"

def getBinding(cgi,env,params)
  return binding
end
def error(cgi, code)
  puts cgi.header
  puts cgi.header("nph" => true, "status" => code, "connection" => "close", "type" => "text/html")
end

script = nil
fhandle = nil
control = nil
pram = nil
is_production = nil
use_errors = nil
FCGI.each_cgi do |cgi|
  is_production = ((cgi.env_table["INK_PRODUCTION"] and eval cgi.env_table["INK_PRODUCTION"]) or (ENV["INK_PRODUCTION"] and eval ENV["INK_PRODUCTION"])) ? true : false
  use_errors = ((cgi.env_table["INK_ERRORS"] and eval cgi.env_table["INK_ERRORS"]) or (ENV["INK_ERRORS"] and eval ENV["INK_ERRORS"])) ? true : false
  time = Time.now
  script = cgi.env_table['SCRIPT_FILENAME']
  begin
    pram = Hash.new
    CGI::parse(cgi.env_table['QUERY_STRING'].gsub(/\?/, "&")).each do |k,v|
      if v.is_a? Array
        if v.length == 0
          pram[k] = nil
        elsif v.length == 1
          pram[k] = v[0]
        else
          pram[k] = v
        end
      else
        pram[k] = v
      end
    end
    control = pram['controller']
    routes = Ink::Beauty.load_routes script
    fhandle = SimpleMmap::MappedFile.new(routes)
    Dir.chdir( File.dirname(routes) )
    control = eval fhandle.read_window_data(0,fhandle.size), getBinding(cgi,cgi.env_table,control) if fhandle
    fhandle.close
    raise StandardError.new("Routes not matched.") if control.keys.length <= 1

    control[:get] = pram
    control[:config] = Ink::Beauty.load_config script
    control[:time] = time
    control[:cgi] = cgi
    control[:env] = ENV
    control[:is_production] = is_production
    control[:use_errors] = use_errors
    if cgi.env_table['REQUEST_METHOD'] == 'POST'
      control[:post] = Hash.new
      cgi.params.each do |k,v|
        if v.is_a? Array
          control[:post][k] = Array.new
          v.each do |a|
            control[:post][k].push((control[:config]["escape_post_data"]) ? CGI::escapeHTML(a) : a)
          end
          control[:post][k] = control[:post][k][0] if control[:post][k].length <= 1
        else
          control[:post][k] = (control[:config]["escape_post_data"]) ? CGI::escapeHTML(v) : v
        end
      end
      pram.each do |k,v|
        cgi.params[k] = v if not cgi.params.has_key? k
      end
    else
      cgi.params = pram
    end

    script = Ink::Beauty.load_init script
    fhandle = SimpleMmap::MappedFile.new(script)
    Dir.chdir( File.dirname(script) )
    eval fhandle.read_window_data(0,fhandle.size), getBinding(cgi,cgi.env_table,control) if fhandle
    fhandle.close

  rescue LoadError => bang
    if is_production
      puts cgi.header({"Location" => "/status-404.html"}) if use_errors
      error cgi, "NOT_FOUND" if not use_errors
    else
      puts cgi.header
      puts "<hr><b>LoadError:</b>", "<em><pre>", CGI::escapeHTML("#{bang}"), "</pre></em>\n", "<pre>", bang.backtrace.join("\n"), "</pre>"
    end

  rescue NotImplementedError => bang
    if is_production
      puts cgi.header({"Location" => "/status-500.html"}) if use_errors
      error cgi, "SERVER_ERROR" if not use_errors
    else
      puts cgi.header
      puts "<hr><b>NotImplementedError:</b>", "<em><pre>", CGI::escapeHTML("#{bang}"), "</pre></em>\n", "<pre>", bang.backtrace.join("\n"), "</pre>"
    end

  rescue ArgumentError => bang
    if is_production
      puts cgi.header({"Location" => "/status-500.html"}) if use_errors
      error cgi, "SERVER_ERROR" if not use_errors
    else
      puts cgi.header
      puts "<hr><b>ArgumentError:</b>", "<em><pre>", CGI::escapeHTML("#{bang}"), "</pre></em>\n", "<pre>", bang.backtrace.join("\n"), "</pre>"
    end

  rescue RuntimeError => bang
    if is_production
      puts cgi.header({"Location" => "/status-500.html"}) if use_errors
      error cgi, "SERVER_ERROR" if not use_errors
    else
      puts cgi.header
      puts "<hr><b>RuntimeError:</b>", "<em><pre>", CGI::escapeHTML("#{bang}"), "</pre></em>\n", "<pre>", bang.backtrace.join("\n"), "</pre>"
    end

  rescue NameError => bang
    if is_production
      puts cgi.header({"Location" => "/status-500.html"}) if use_errors
      error cgi, "SERVER_ERROR" if not use_errors
    else
      puts cgi.header
      puts "<hr><b>NameError:</b>", "<em><pre>", CGI::escapeHTML("#{bang}"), "</pre></em>\n", "<pre>", bang.backtrace.join("\n"), "</pre>"
    end

  rescue Exception, StandardError => bang
    if is_production
      puts cgi.header({"Location" => "/status-500.html"}) if use_errors
      error cgi, "SERVER_ERROR" if not use_errors
    else
      puts cgi.header
      puts "<hr><b>Exception:</b>", "<em><pre>", CGI::escapeHTML("#{bang}"), "</pre></em>\n", "<pre>", bang.backtrace.join("\n"), "</pre>"
    end
  end

  script = nil
  fhandle = nil
  control = nil
  pram = nil
  GC.start
end

